<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute Cams</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #111;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .header h1 { font-size: 0.95em; font-weight: 500; color: #888; }
        .header .time { font-size: 1.1em; font-weight: 300; }
        .header .info { font-size: 0.75em; color: #555; }
        .tabs {
            display: flex;
            gap: 6px;
            padding: 6px 12px;
            background: #111;
            overflow-x: auto;
            flex-shrink: 0;
            border-bottom: 1px solid #222;
        }
        .tab {
            padding: 4px 12px;
            background: #222;
            border: none;
            border-radius: 12px;
            color: #666;
            cursor: pointer;
            font-size: 0.8em;
            white-space: nowrap;
        }
        .tab.active { background: #0066cc; color: #fff; }
        .tab .count {
            background: rgba(255,255,255,0.2);
            padding: 1px 5px;
            border-radius: 6px;
            margin-left: 3px;
            font-size: 0.85em;
        }
        .grid {
            flex: 1;
            display: grid;
            gap: 2px;
            padding: 2px;
            overflow: hidden;
        }
        .cam {
            position: relative;
            background: #000;
            min-width: 0;
            min-height: 0;
        }
        .cam video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .cam .badge {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,100,200,0.8);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65em;
            font-weight: 600;
        }
        .cam .dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #333;
        }
        .cam .dot.live { background: #0c6; animation: pulse 2s infinite; }
        .cam .dot.err { background: #c33; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .fs {
            position: fixed;
            inset: 0;
            z-index: 999;
            background: #000;
        }
        .fs video { width: 100%; height: 100%; object-fit: contain; }
        .fs .x {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0,0,0,0.6);
            border: none;
            color: #fff;
            padding: 6px 14px;
            border-radius: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Culver City → Long Beach</h1>
        <span class="info">23 cams • Jan 11, 08:15 PM</span>
        <span class="time" id="clock"></span>
    </div>
    <div class="tabs">
        <button class="tab active" data-r="all">All <span class="count">23</span></button>
        <button class="tab" data-r="405">405 <span class="count">2</span></button>
        <button class="tab" data-r="710">710 <span class="count">7</span></button>
        <button class="tab" data-r="110">110 <span class="count">9</span></button>
        <button class="tab" data-r="10">10 <span class="count">5</span></button>
    </div>
    <div class="grid" id="grid"></div>
<script>
const cams = [
    {r:"405",s:"https://wzmedia.dot.ca.gov/D7/CCTV-359.stream/playlist.m3u8"},
    {r:"405",s:"https://wzmedia.dot.ca.gov/D7/CCTV-345.stream/playlist.m3u8"},
    {r:"710",s:"https://wzmedia.dot.ca.gov/D7/CCTV-285.stream/playlist.m3u8"},
    {r:"710",s:"https://wzmedia.dot.ca.gov/D7/CCTV-283.stream/playlist.m3u8"},
    {r:"710",s:"https://wzmedia.dot.ca.gov/D7/CCTV-271.stream/playlist.m3u8"},
    {r:"710",s:"https://wzmedia.dot.ca.gov/D7/CCTV-269.stream/playlist.m3u8"},
    {r:"710",s:"https://wzmedia.dot.ca.gov/D7/CCTV-268.stream/playlist.m3u8"},
    {r:"710",s:"https://wzmedia.dot.ca.gov/D7/CCTV-267.stream/playlist.m3u8"},
    {r:"710",s:"https://wzmedia.dot.ca.gov/D7/CCTV-954.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-184.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-178.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-177.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-175.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-171.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-170.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-167.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-164.stream/playlist.m3u8"},
    {r:"110",s:"https://wzmedia.dot.ca.gov/D7/CCTV-166.stream/playlist.m3u8"},
    {r:"10",s:"https://wzmedia.dot.ca.gov/D7/CCTV-126.stream/playlist.m3u8"},
    {r:"10",s:"https://wzmedia.dot.ca.gov/D7/CCTV-125.stream/playlist.m3u8"},
    {r:"10",s:"https://wzmedia.dot.ca.gov/D7/CCTV-123.stream/playlist.m3u8"},
    {r:"10",s:"https://wzmedia.dot.ca.gov/D7/CCTV-117.stream/playlist.m3u8"},
    {r:"10",s:"https://wzmedia.dot.ca.gov/D7/CCTV-101.stream/playlist.m3u8"}
];

const players = new Map();

function updateClock() {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true
    });
}

function mkCam(c, i) {
    const d = document.createElement('div');
    d.className = 'cam';
    d.dataset.r = c.r;
    d.innerHTML = `
        <video id="v${i}" muted playsinline></video>
        <div class="badge">${c.r}</div>
        <div class="dot" id="d${i}"></div>
    `;
    d.onclick = () => fullscreen(i);
    return d;
}

function initHls(i, url) {
    const v = document.getElementById('v'+i);
    const d = document.getElementById('d'+i);

    if (Hls.isSupported()) {
        const h = new Hls({ enableWorker: true, lowLatencyMode: true });
        h.loadSource(url);
        h.attachMedia(v);
        h.on(Hls.Events.MANIFEST_PARSED, () => { v.play().catch(()=>{}); d.className='dot live'; });
        h.on(Hls.Events.ERROR, (_,e) => {
            if (e.fatal) { d.className='dot err'; setTimeout(() => h.loadSource(url), 15000); }
        });
        players.set(i, h);
    } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
        v.src = url;
        v.onloadedmetadata = () => { v.play().catch(()=>{}); d.className='dot live'; };
    }
}

function filter(r) {
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.r === r));
    document.querySelectorAll('.cam').forEach(c => c.style.display = (r==='all' || c.dataset.r===r) ? 'block' : 'none');
}

function fullscreen(i) {
    if (document.querySelector('.fs')) { document.querySelector('.fs').remove(); return; }
    const d = document.createElement('div');
    d.className = 'fs';
    d.innerHTML = `<video id="fsv" muted playsinline autoplay></video><button class="x">✕</button>`;
    document.body.appendChild(d);

    const v = document.getElementById('fsv');
    if (Hls.isSupported()) {
        const h = new Hls();
        h.loadSource(cams[i].s);
        h.attachMedia(v);
        h.on(Hls.Events.MANIFEST_PARSED, () => v.play());
    } else v.src = cams[i].s;

    d.querySelector('.x').onclick = () => d.remove();
}

function layoutGrid() {
    const grid = document.getElementById('grid');
    const visible = [...document.querySelectorAll('.cam')].filter(c => c.style.display !== 'none');
    const n = visible.length;
    if (n === 0) return;

    const rect = grid.getBoundingClientRect();
    const w = rect.width - 4;  // padding
    const h = rect.height - 4;
    const ratio = 4/3;  // camera aspect ratio

    // Find optimal grid that fills space
    let bestCols = 1, bestRows = n, bestSize = 0;
    for (let cols = 1; cols <= n; cols++) {
        const rows = Math.ceil(n / cols);
        const cellW = w / cols;
        const cellH = h / rows;
        // Size limited by either width or height
        const size = Math.min(cellW, cellH * ratio);
        if (size > bestSize) {
            bestSize = size;
            bestCols = cols;
            bestRows = rows;
        }
    }

    grid.style.gridTemplateColumns = `repeat(${bestCols}, 1fr)`;
    grid.style.gridTemplateRows = `repeat(${bestRows}, 1fr)`;
}

document.addEventListener('DOMContentLoaded', () => {
    const g = document.getElementById('grid');
    cams.forEach((c,i) => { g.appendChild(mkCam(c,i)); initHls(i, c.s); });
    document.querySelectorAll('.tab').forEach(t => t.onclick = () => { filter(t.dataset.r); layoutGrid(); });
    updateClock();
    setInterval(updateClock, 1000);
    layoutGrid();
    window.addEventListener('resize', layoutGrid);
});
</script>
</body>
</html>